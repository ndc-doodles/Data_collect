<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" crossorigin="anonymous" />

  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .input-sm::placeholder { color: #d8b4fe; }
  </style>
</head>

<body class="min-h-screen flex text-white bg-gradient-to-br from-[#1a0826] via-[#3b0f4a] to-[#0f1c3f]">

<!-- SIDEBAR -->
<aside class="w-64 hidden md:flex flex-col h-screen sticky top-0 bg-gradient-to-b from-[#2b0f3a] to-[#14091f] border-r border-white/10">
  <div class="p-6 text-xl font-bold text-purple-300 border-b border-white/10">Admin Panel</div>
  <nav class="flex-1 p-4 space-y-2 text-purple-200">
     <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
      Dashboard
    </a>
      <a href="{% url 'inbox' %}"
   class="relative flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">

  Inbox

  <!-- ðŸ”´ Red Dot -->
  <span id="unreadDot"
        class="hidden absolute top-2 right-3 w-2.5 h-2.5 bg-red-500 rounded-full">
  </span>
</a>

    <a href="{% url 'category' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
      Category & Sub Category
    </a>
    <a href="{% url 'state_district' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
     State & District
    </a>
    <a href="{% url 'data' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
    Quick Entry
    </a>
      <a href="{% url 'data_list' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
    Uploads
    </a>
      <a href="{% url 'usercreate' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
   Create Users
    </a>
       <a href="{% url 'userlist' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg
              bg-gradient-to-r from-purple-600/40 to-pink-500/40">
   Users
    </a>

      <a href="{% url 'superuser_change_password' %}" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white/10">
  Change Password
    </a>
  </nav>
  <div class="p-4 border-t border-white/10">
    <a href="{% url 'superuser_logout' %}" class="block text-center bg-gradient-to-r from-pink-500 to-red-500 text-white py-2 rounded-lg hover:opacity-90">Logout</a>
  </div>
</aside>

<!-- MAIN -->
<div class="flex-1 flex flex-col">

<!-- TOP BAR -->
<header class="px-6 h-[4.78rem] flex justify-between items-center sticky top-0 z-40 bg-white/5 backdrop-blur-xl border-b border-white/10">
  <h1 class="text-xl font-semibold text-purple-200">Users List</h1>
  <div class="flex items-center gap-3">
    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center font-bold">
      {{ request.user.username|first|upper }}
    </div>
    <span class="text-purple-200 font-medium">{{ request.user.username }}</span>
  </div>
</header>

<main class="flex justify-center items-start min-h-[calc(100vh-4.78rem)] p-6">
  <div class="w-full max-w-6xl">

    <!-- Page Title -->
    <h2 class="text-2xl font-bold text-purple-200 mb-4">Users List</h2>

    <!-- Totals Cards -->
    <div class="flex flex-wrap gap-4 mb-4">
      <div class="bg-purple-800 text-white rounded-lg px-6 py-4 shadow-md flex-1">
        <h3 class="text-sm font-medium uppercase text-purple-300">Total Users</h3>
        <p class="text-2xl font-bold">{{ total_users }}</p>
      </div>
      <div class="bg-purple-800 text-white rounded-lg px-6 py-4 shadow-md flex-1">
        <h3 class="text-sm font-medium uppercase text-purple-300">Total Uploads</h3>
        <p class="text-2xl font-bold">{{ total_uploads }}</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-col sm:flex-row gap-4 mb-4">
      <form method="get" class="flex flex-col sm:flex-row gap-2 w-full" id="filterForm">
        <input type="text" name="search" placeholder="Search by ID or username"
               value="{{ search_query }}" id="searchInput"
               class="px-4 py-2 rounded-lg bg-[#1a0826] text-purple-100 placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 flex-1" />

        <input type="date" name="start_date" value="{{ start_date }}" id="startDate"
               class="px-4 py-2 rounded-lg bg-[#1a0826] text-purple-100 placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />

        <input type="date" name="end_date" value="{{ end_date }}" id="endDate"
               class="px-4 py-2 rounded-lg bg-[#1a0826] text-purple-100 placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500" />

        <button type="submit"
                class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-500 rounded-lg text-white font-semibold hover:opacity-90 transition">
          Filter
        </button>
      </form>
    </div>

    <!-- Users Table -->
<div class="overflow-y-auto h-96 rounded-lg shadow-lg bg-gradient-to-r from-[#2b0f3a] to-[#14091f] scrollbar-hide">
  <table class="min-w-full divide-y divide-purple-700">
    <thead class="bg-gradient-to-r from-purple-700 via-purple-900 to-purple-700 sticky top-0 z-10">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Username</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Last Login</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Uploads</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-purple-800" id="usersTableBody">
      {% for user in users %}
      <tr id="user-row-{{ user.id }}" class="hover:bg-purple-800 transition-colors duration-200">
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-purple-200">{{ user.id }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-100">{{ user.username }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-100">{{ user.last_login|date:"d M Y H:i:s" }}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-100">{{ user.upload_count }}</td>
        <td class="px-6 py-4">
    <button onclick="toggleUser('{{ user.id }}', {{ user.is_active|yesno:'true,false' }})"
            class="px-3 py-1 rounded text-white transition"
            style="background-color: {{ user.is_active|yesno:'#f59e0b,#10b981' }};">
      {{ user.is_active|yesno:'Disable,Enable' }}
    </button>
  </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="px-6 py-4 text-center text-purple-300">No users found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  </div>
</main>

</div>

<script>
const searchInput = document.getElementById('searchInput');
const startDate = document.getElementById('startDate');
const endDate = document.getElementById('endDate');

function fetchUsers() {
  const params = new URLSearchParams();
  if (searchInput.value) params.append('search', searchInput.value);
  if (startDate.value) params.append('start_date', startDate.value);
  if (endDate.value) params.append('end_date', endDate.value);

  fetch(window.location.pathname + '?' + params.toString(), {
    headers: { 'x-requested-with': 'XMLHttpRequest' }
  })
  .then(res => res.json())
  .then(data => {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    if (data.users.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-6 py-4 text-center text-purple-300">
            No users found.
          </td>
        </tr>`;
      return;
    }

    data.users.forEach(user => {
      const row = `
        <tr class="hover:bg-purple-800 transition-colors duration-200">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-purple-200">${user.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-100">${user.username}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-100">${user.last_login}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-100">${user.upload_count}</td>
        </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  });
}

// Use 'input' for typing, 'change' for dates
searchInput.addEventListener('input', fetchUsers);
startDate.addEventListener('change', fetchUsers);
endDate.addEventListener('change', fetchUsers);

</script>

<script>
function toggleUser(userId, isActive) {
  const action = isActive ? 'disable' : 'enable';
  const confirmMsg = isActive
    ? "Are you sure you want to disable this user?"
    : "Are you sure you want to enable this user?";

  if (!confirm(confirmMsg)) return;

  fetch("{% url 'userlist' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({
      'action': action,
      'user_id': userId
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'success') {
      // Update button dynamically
      const row = document.getElementById(`user-row-${userId}`);
      const btn = row.querySelector('button');
      if (data.new_status === 'active') {
        btn.textContent = 'Disable';
        btn.style.backgroundColor = '#f59e0b';  // yellow
        btn.setAttribute('onclick', `toggleUser('${userId}', true)`);
      } else {
        btn.textContent = 'Enable';
        btn.style.backgroundColor = '#10b981';  // green
        btn.setAttribute('onclick', `toggleUser('${userId}', false)`);
      }
    } else {
      alert(data.message);
    }
  })
  .catch(err => alert("Error toggling user status"));
}

</script>

<script>
async function checkUnreadUploads() {
  try {
    const res = await fetch("{% url 'unread_uploads_count' %}", {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (!res.ok) return;

    const data = await res.json();
    const dot = document.getElementById('unreadDot');

    if (data.unread_count > 0) {
      dot.classList.remove('hidden');
    } else {
      dot.classList.add('hidden');
    }
  } catch (err) {
    console.error('Unread check failed', err);
  }
}

document.addEventListener('DOMContentLoaded', checkUnreadUploads);
</script>


</body>
</html>
